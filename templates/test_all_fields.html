{% extends 'base.html' %}
{% block page_title %}ØªØ³Øª Ú©Ø§Ù…Ù„ ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ø¯Ø§ÛŒÙ†Ø§Ù…ÛŒÚ©{% endblock %}
{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">
                        <i class="fas fa-flask"></i> ØªØ³Øª Ú©Ø§Ù…Ù„ ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ø¯Ø§ÛŒÙ†Ø§Ù…ÛŒÚ©
                    </h4>
                </div>
                <div class="card-body">
                    <!-- Test Controls -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-primary" onclick="testAPI()">
                                    <i class="fas fa-download"></i> ØªØ³Øª API
                                </button>
                                <button type="button" class="btn btn-success" onclick="testValidation()">
                                    <i class="fas fa-check-circle"></i> ØªØ³Øª Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ
                                </button>
                                <button type="button" class="btn btn-info" onclick="testSave()">
                                    <i class="fas fa-save"></i> ØªØ³Øª Ø°Ø®ÛŒØ±Ù‡
                                </button>
                                <button type="button" class="btn btn-warning" onclick="refreshFields()">
                                    <i class="fas fa-sync"></i> Ø¨Ø§Ø²Ø®ÙˆØ§Ù†ÛŒ
                                </button>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="input-group">
                                <select class="form-select" id="modelSelect">
                                    <option value="User">Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</option>
                                    <option value="Server">Ø³Ø±ÙˆØ±Ù‡Ø§</option>
                                    <option value="Task">ØªØ³Ú©â€ŒÙ‡Ø§</option>
                                    <option value="Content">Ù…Ø­ØªÙˆØ§</option>
                                    <option value="Backup">Ø¨Ú©Ø§Ù¾â€ŒÙ‡Ø§</option>
                                    <option value="SecurityProject">Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ù…Ù†ÛŒØªÛŒ</option>
                                    <option value="Credential">Ø§Ø¹ØªØ¨Ø§Ø±Ù†Ø§Ù…Ù‡â€ŒÙ‡Ø§</option>
                                    <option value="Bookmark">Ù†Ø´Ø§Ù†Ú©â€ŒÙ‡Ø§</option>
                                    <option value="Person">Ø§Ø´Ø®Ø§Øµ</option>
                                </select>
                                <button class="btn btn-outline-secondary" onclick="changeModel()">
                                    <i class="fas fa-exchange-alt"></i> ØªØºÛŒÛŒØ± Ù…Ø¯Ù„
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- API Test Results -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">Ù†ØªØ§ÛŒØ¬ ØªØ³Øª API</h6>
                                </div>
                                <div class="card-body">
                                    <div id="apiResults" class="bg-light p-3 rounded">
                                        <em>Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ØŒ Ø¯Ú©Ù…Ù‡ "ØªØ³Øª API" Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯</em>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Dynamic Fields Container -->
                    <div class="row">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ø¯Ø§ÛŒÙ†Ø§Ù…ÛŒÚ© - Ù…Ø¯Ù„: <span id="currentModel">User</span></h6>
                                </div>
                                <div class="card-body">
                                    <div id="dynamicFieldsContainer" data-dynamic-fields data-model="User">
                                        <div class="text-center">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</span>
                                            </div>
                                            <p class="mt-2">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ÙÛŒÙ„Ø¯Ù‡Ø§...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Field Values Display -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">Ù…Ù‚Ø§Ø¯ÛŒØ± ÙÛŒÙ„Ø¯Ù‡Ø§</h6>
                                </div>
                                <div class="card-body">
                                    <pre id="fieldValues" class="bg-light p-3 rounded">Ù…Ù‚Ø§Ø¯ÛŒØ± ÙÛŒÙ„Ø¯Ù‡Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯</pre>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/dynamic-fields-v2.js') }}"></script>
<script>
let currentManager = null;

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸš€ Test page loaded');
    initializeFields();
});

function initializeFields() {
    const modelName = document.getElementById('modelSelect').value;
    const container = document.getElementById('dynamicFieldsContainer');
    
    // Clear container
    container.innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ÙÛŒÙ„Ø¯Ù‡Ø§...</p></div>';
    
    // Initialize manager
    currentManager = new DynamicFieldsManagerV2(modelName, 'dynamicFieldsContainer');
    currentManager.setCurrentRecordId(1); // Test with record ID 1
    
    // Update UI
    document.getElementById('currentModel').textContent = modelName;
    
    console.log(`âœ… Initialized fields for model: ${modelName}`);
}

function changeModel() {
    const newModel = document.getElementById('modelSelect').value;
    console.log(`ğŸ”„ Changing model to: ${newModel}`);
    initializeFields();
}

async function testAPI() {
    const modelName = document.getElementById('modelSelect').value;
    const resultsDiv = document.getElementById('apiResults');
    
    resultsDiv.innerHTML = '<div class="text-center"><div class="spinner-border spinner-border-sm"></div> Ø¯Ø± Ø­Ø§Ù„ ØªØ³Øª API...</div>';
    
    try {
        console.log(`ğŸ§ª Testing API for model: ${modelName}`);
        
        const response = await fetch(`/api/custom-fields/${modelName}?t=${Date.now()}`);
        const data = await response.json();
        
        console.log('ğŸ“Š API Response:', data);
        
        resultsDiv.innerHTML = `
            <div class="alert alert-success">
                <h6><i class="fas fa-check-circle"></i> API ØªØ³Øª Ù…ÙˆÙÙ‚</h6>
                <p><strong>ÙˆØ¶Ø¹ÛŒØª:</strong> ${response.status} ${response.statusText}</p>
                <p><strong>ØªØ¹Ø¯Ø§Ø¯ ÙÛŒÙ„Ø¯Ù‡Ø§:</strong> ${data.length}</p>
                <details>
                    <summary>Ø¬Ø²Ø¦ÛŒØ§Øª Ù¾Ø§Ø³Ø®</summary>
                    <pre class="mt-2">${JSON.stringify(data, null, 2)}</pre>
                </details>
            </div>
        `;
        
    } catch (error) {
        console.error('âŒ API Test failed:', error);
        resultsDiv.innerHTML = `
            <div class="alert alert-danger">
                <h6><i class="fas fa-exclamation-triangle"></i> Ø®Ø·Ø§ Ø¯Ø± ØªØ³Øª API</h6>
                <p><strong>Ø®Ø·Ø§:</strong> ${error.message}</p>
            </div>
        `;
    }
}

function testValidation() {
    if (!currentManager) {
        alert('Ù…Ø¯ÛŒØ± ÙÛŒÙ„Ø¯Ù‡Ø§ Ù‡Ù†ÙˆØ² Ø¢Ù…Ø§Ø¯Ù‡ Ù†ÛŒØ³Øª');
        return;
    }
    
    console.log('ğŸ§ª Testing field validation...');
    
    const isValid = currentManager.validateAllFields();
    const resultsDiv = document.getElementById('apiResults');
    
    if (isValid) {
        resultsDiv.innerHTML = `
            <div class="alert alert-success">
                <h6><i class="fas fa-check-circle"></i> Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ù…ÙˆÙÙ‚</h6>
                <p>Ù‡Ù…Ù‡ ÙÛŒÙ„Ø¯Ù‡Ø§ Ù…Ø¹ØªØ¨Ø± Ù‡Ø³ØªÙ†Ø¯</p>
            </div>
        `;
    } else {
        resultsDiv.innerHTML = `
            <div class="alert alert-warning">
                <h6><i class="fas fa-exclamation-triangle"></i> Ø®Ø·Ø§ Ø¯Ø± Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ</h6>
                <p>Ø¨Ø±Ø®ÛŒ ÙÛŒÙ„Ø¯Ù‡Ø§ Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³ØªÙ†Ø¯. Ù„Ø·ÙØ§Ù‹ Ø®Ø·Ø§Ù‡Ø§ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯.</p>
            </div>
        `;
    }
}

function testSave() {
    if (!currentManager) {
        alert('Ù…Ø¯ÛŒØ± ÙÛŒÙ„Ø¯Ù‡Ø§ Ù‡Ù†ÙˆØ² Ø¢Ù…Ø§Ø¯Ù‡ Ù†ÛŒØ³Øª');
        return;
    }
    
    console.log('ğŸ§ª Testing field save...');
    
    const values = currentManager.getAllFieldValues();
    const resultsDiv = document.getElementById('apiResults');
    
    resultsDiv.innerHTML = `
        <div class="alert alert-info">
            <h6><i class="fas fa-info-circle"></i> ØªØ³Øª Ø°Ø®ÛŒØ±Ù‡</h6>
            <p>Ù…Ù‚Ø§Ø¯ÛŒØ± ÙÛŒÙ„Ø¯Ù‡Ø§ Ø¨Ø±Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ø¢Ù…Ø§Ø¯Ù‡ Ø´Ø¯Ù‡â€ŒØ§Ù†Ø¯:</p>
            <pre class="mt-2">${JSON.stringify(values, null, 2)}</pre>
        </div>
    `;
    
    // Update field values display
    document.getElementById('fieldValues').textContent = JSON.stringify(values, null, 2);
}

function refreshFields() {
    if (!currentManager) {
        alert('Ù…Ø¯ÛŒØ± ÙÛŒÙ„Ø¯Ù‡Ø§ Ù‡Ù†ÙˆØ² Ø¢Ù…Ø§Ø¯Ù‡ Ù†ÛŒØ³Øª');
        return;
    }
    
    console.log('ğŸ”„ Refreshing fields...');
    currentManager.refreshFields();
    
    const resultsDiv = document.getElementById('apiResults');
    resultsDiv.innerHTML = `
        <div class="alert alert-info">
            <h6><i class="fas fa-sync"></i> Ø¨Ø§Ø²Ø®ÙˆØ§Ù†ÛŒ ÙÛŒÙ„Ø¯Ù‡Ø§</h6>
            <p>ÙÛŒÙ„Ø¯Ù‡Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ø§Ø²Ø®ÙˆØ§Ù†ÛŒ Ø´Ø¯Ù†Ø¯</p>
        </div>
    `;
}

// Update field values display periodically
setInterval(() => {
    if (currentManager) {
        const values = currentManager.getAllFieldValues();
        document.getElementById('fieldValues').textContent = JSON.stringify(values, null, 2);
    }
}, 2000);
</script>
{% endblock %}
