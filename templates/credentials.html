{% extends 'base.html' %}
{% block page_title %}مدیریت رمزها{% endblock %}

{% block head %}
<style>
.modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: 1050;
  background-color: rgba(0, 0, 0, 0.5);
}

.modal.show {
  display: block !important;
}

.modal-dialog {
  position: relative;
  width: auto;
  max-width: 500px;
  margin: 1.75rem auto;
  pointer-events: none;
}

.modal-content {
  position: relative;
  display: flex;
  flex-direction: column;
  width: 100%;
  pointer-events: auto;
  background-color: #fff;
  background-clip: padding-box;
  border: 1px solid rgba(0, 0, 0, 0.2);
  border-radius: 0.3rem;
  outline: 0;
}

.modal-backdrop {
  position: fixed;
  top: 0;
  left: 0;
  z-index: 1040;
  width: 100vw;
  height: 100vh;
  background-color: #000;
}

.modal-backdrop.show {
  opacity: 0.5;
}

.btn-close {
  background: none;
  border: none;
  font-size: 1.5rem;
  cursor: pointer;
  padding: 0;
  margin: -0.5rem -0.5rem -0.5rem auto;
}

.btn-close:hover {
  opacity: 0.75;
}
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
  <div class="col-12">
    <div class="d-flex justify-content-between align-items-center">
      <h2><i class="fas fa-key text-primary"></i> مدیریت رمزها</h2>
      <a href="{{ url_for('add_credential') }}" class="btn btn-primary">
        <i class="fas fa-plus"></i> اضافه کردن رمز جدید
      </a>
    </div>
  </div>
</div>

<!-- فیلترها -->
<div class="row mb-4">
  <div class="col-12">
    <div class="card">
      <div class="card-body">
        <form method="GET" class="row g-3">
          <div class="col-md-4">
            <input type="text" name="query" class="form-control" placeholder="جستجو در نام، نام کاربری یا توضیحات..." value="{{ request.args.get('query', '') }}">
          </div>
          <div class="col-md-3">
            <select name="service_type" class="form-select">
              <option value="">همه انواع سرویس</option>
              <option value="server" {% if request.args.get('service_type') == 'server' %}selected{% endif %}>سرور</option>
              <option value="database" {% if request.args.get('service_type') == 'database' %}selected{% endif %}>دیتابیس</option>
              <option value="application" {% if request.args.get('service_type') == 'application' %}selected{% endif %}>اپلیکیشن</option>
              <option value="email" {% if request.args.get('service_type') == 'email' %}selected{% endif %}>ایمیل</option>
              <option value="cloud" {% if request.args.get('service_type') == 'cloud' %}selected{% endif %}>کلود</option>
              <option value="social" {% if request.args.get('service_type') == 'social' %}selected{% endif %}>شبکه اجتماعی</option>
              <option value="payment" {% if request.args.get('service_type') == 'payment' %}selected{% endif %}>درگاه پرداخت</option>
              <option value="other" {% if request.args.get('service_type') == 'other' %}selected{% endif %}>سایر</option>
            </select>
          </div>
          <div class="col-md-3">
            <input type="text" name="tags" class="form-control" placeholder="برچسب..." value="{{ request.args.get('tags', '') }}">
          </div>
          <div class="col-md-2">
            <button type="submit" class="btn btn-outline-primary w-100">
              <i class="fas fa-search"></i> جستجو
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- لیست رمزها -->
<div class="row">
  <div class="col-12">
    <div class="card">
      <div class="card-body">
        {% if credentials.items %}
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>نام سرویس</th>
                  <th>نوع</th>
                  <th>نام کاربری</th>
                  <th>آدرس</th>
                  <th>برچسب‌ها</th>
                  <th>وضعیت</th>
                  <th>آخرین استفاده</th>
                  <th>عملیات</th>
                </tr>
              </thead>
              <tbody>
                {% for credential in credentials.items %}
                <tr>
                  <td>
                    <div class="d-flex align-items-center">
                      <i class="fas fa-{{ 'server' if credential.service_type == 'server' else 'database' if credential.service_type == 'database' else 'desktop' if credential.service_type == 'application' else 'envelope' if credential.service_type == 'email' else 'cloud' if credential.service_type == 'cloud' else 'users' if credential.service_type == 'social' else 'credit-card' if credential.service_type == 'payment' else 'key' }} text-primary me-2"></i>
                      <strong>{{ credential.name }}</strong>
                    </div>
                  </td>
                  <td>
                    <span class="badge bg-{{ 'primary' if credential.service_type == 'server' else 'info' if credential.service_type == 'database' else 'success' if credential.service_type == 'application' else 'warning' if credential.service_type == 'email' else 'secondary' if credential.service_type == 'cloud' else 'dark' if credential.service_type == 'social' else 'danger' if credential.service_type == 'payment' else 'light' }}">
                      {{ credential.service_type }}
                    </span>
                  </td>
                  <td>{{ credential.username }}</td>
                  <td>
                    {% if credential.url %}
                      <a href="{{ credential.url }}" target="_blank" class="text-decoration-none">
                        <i class="fas fa-external-link-alt"></i> باز کردن
                      </a>
                    {% else %}
                      <span class="text-muted">-</span>
                    {% endif %}
                  </td>
                  <td>
                    {% for tag in credential.get_tags_list() %}
                      <span class="badge bg-light text-dark me-1">{{ tag }}</span>
                    {% endfor %}
                  </td>
                  <td>
                    {% if credential.is_active %}
                      <span class="badge bg-success">فعال</span>
                    {% else %}
                      <span class="badge bg-danger">غیرفعال</span>
                    {% endif %}
                  </td>
                  <td>
                    {% if credential.last_used %}
                      <small class="text-muted">{{ credential.last_used.strftime('%Y/%m/%d %H:%M') }}</small>
                    {% else %}
                      <small class="text-muted">هرگز</small>
                    {% endif %}
                  </td>
                  <td>
                    <div class="btn-group" role="group">
                      <a href="{{ url_for('view_credential', id=credential.id) }}" class="btn btn-sm btn-outline-info" title="مشاهده">
                        <i class="fas fa-eye"></i>
                      </a>
                      <a href="{{ url_for('edit_credential', id=credential.id) }}" class="btn btn-sm btn-outline-warning" title="ویرایش">
                        <i class="fas fa-edit"></i>
                      </a>
                      <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteCredential({{ credential.id }})" title="حذف">
                        <i class="fas fa-trash"></i>
                      </button>
                    </div>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          
          <!-- Pagination -->
          {% if credentials.pages > 1 %}
          <nav aria-label="صفحه‌بندی">
            <ul class="pagination justify-content-center">
              {% if credentials.has_prev %}
                <li class="page-item">
                  <a class="page-link" href="{{ url_for('credentials', page=credentials.prev_num, **request.args) }}">قبلی</a>
                </li>
              {% endif %}
              
              {% for page_num in credentials.iter_pages() %}
                {% if page_num %}
                  {% if page_num != credentials.page %}
                    <li class="page-item">
                      <a class="page-link" href="{{ url_for('credentials', page=page_num, **request.args) }}">{{ page_num }}</a>
                    </li>
                  {% else %}
                    <li class="page-item active">
                      <span class="page-link">{{ page_num }}</span>
                    </li>
                  {% endif %}
                {% else %}
                  <li class="page-item disabled">
                    <span class="page-link">...</span>
                  </li>
                {% endif %}
              {% endfor %}
              
              {% if credentials.has_next %}
                <li class="page-item">
                  <a class="page-link" href="{{ url_for('credentials', page=credentials.next_num, **request.args) }}">بعدی</a>
                </li>
              {% endif %}
            </ul>
          </nav>
          {% endif %}
        {% else %}
          <div class="text-center py-5">
            <i class="fas fa-key fa-3x text-muted mb-3"></i>
            <h4 class="text-muted">هیچ رمزی یافت نشد</h4>
            <p class="text-muted">برای شروع، رمز عبور جدیدی اضافه کنید.</p>
            <a href="{{ url_for('add_credential') }}" class="btn btn-primary">
              <i class="fas fa-plus"></i> اضافه کردن رمز جدید
            </a>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Modal حذف -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true" style="display: none;">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteModalLabel">تأیید حذف</h5>
        <button type="button" class="btn-close" onclick="closeModal()" aria-label="Close">&times;</button>
      </div>
      <div class="modal-body">
        <p>آیا مطمئن هستید که می‌خواهید این رمز عبور را حذف کنید؟</p>
        <p class="text-danger"><strong>این عمل قابل بازگشت نیست!</strong></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="closeModal()">انصراف</button>
        <form id="deleteForm" method="POST" style="display: inline;">
          <button type="submit" class="btn btn-danger">حذف</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Backdrop for modal -->
<l class="modal-backdrop fade" id="modalBackdrop" style="display: none;"></div>
{% endblock %}

{% block scripts %}
<script>
function deleteCredential(id) {
  console.log('Delete credential ID:', id);
  
  const deleteForm = document.getElementById('deleteForm');
  if (!deleteForm) {
    console.error('Delete form not found');
    return;
  }
  
  deleteForm.action = '{{ url_for("delete_credential", id=0) }}'.replace('0', id);
  console.log('Form action set to:', deleteForm.action);
  
  // Show modal manually
  showModal();
}

function showModal() {
  const modalElement = document.getElementById('deleteModal');
  const backdropElement = document.getElementById('modalBackdrop');
  
  if (modalElement) {
    modalElement.style.display = 'block';
    modalElement.classList.add('show');
    document.body.classList.add('modal-open');
    
    if (backdropElement) {
      backdropElement.style.display = 'block';
      backdropElement.classList.add('show');
    }
    
    // Focus on modal
    modalElement.focus();
  }
}

// Helper functions
function closeModal() {
  const modalElement = document.getElementById('deleteModal');
  const backdropElement = document.getElementById('modalBackdrop');
  
  if (modalElement) {
    modalElement.style.display = 'none';
    modalElement.classList.remove('show');
    document.body.classList.remove('modal-open');
  }
  
  if (backdropElement) {
    backdropElement.style.display = 'none';
    backdropElement.classList.remove('show');
  }
}

function submitDelete() {
  console.log('Submitting delete form');
  const form = document.getElementById('deleteForm');
  if (form) {
    form.submit();
  }
}

// Ensure modal works when page loads
document.addEventListener('DOMContentLoaded', function() {
  console.log('DOM loaded, checking modal functionality');
  
  // Test if Bootstrap is available
  if (typeof bootstrap !== 'undefined') {
    console.log('Bootstrap 5 detected');
  } else if (typeof $ !== 'undefined' && $.fn.modal) {
    console.log('jQuery Bootstrap detected');
  } else {
    console.log('No Bootstrap detected, using manual modal');
  }
  
  // Add event listeners for manual modal handling
  const modalElement = document.getElementById('deleteModal');
  if (modalElement) {
    // Close modal when clicking outside
    modalElement.addEventListener('click', function(e) {
      if (e.target === modalElement) {
        closeModal();
      }
    });
    
    // Close modal with Escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && modalElement.classList.contains('show')) {
        closeModal();
      }
    });
  }
});
</script>
{% endblock %}